<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Character Web</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Serif+Display:ital@0;1&display=swap');

:root {
  --ink: #1c1917;
  --ink2: #57534e;
  --ink3: #a8a29e;
  --paper: #fafaf9;
  --card: #ffffff;
  --line: #e7e5e4;
  --line2: #d6d3d1;
  --violet: #7c3aed;
  --violet-light: #ede9fe;
  --violet-mid: #8b5cf6;
  --red: #dc2626;
  --green: #16a34a;
  --r: 6px;
  --r2: 12px;
  --sh: 0 1px 3px rgba(0,0,0,.08), 0 4px 12px rgba(0,0,0,.06);
  --sh2: 0 4px 24px rgba(0,0,0,.12);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; touch-action: none; }
body {
  font-family: 'DM Sans', system-ui, sans-serif;
  background: var(--paper);
  color: var(--ink);
  display: flex;
  flex-direction: column;
  user-select: none;
  -webkit-user-select: none;
}

/* ‚îÄ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ‚îÄ */
::-webkit-scrollbar { width: 3px; height: 3px; }
::-webkit-scrollbar-thumb { background: var(--line2); border-radius: 4px; }

/* ‚îÄ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ‚îÄ */
#topbar {
  display: flex; align-items: center; gap: 6px;
  padding: 0 10px; height: 48px;
  background: var(--card); border-bottom: 1px solid var(--line);
  box-shadow: var(--sh); z-index: 200; flex-shrink: 0;
  overflow-x: auto; overflow-y: hidden;
}
#topbar::-webkit-scrollbar { height: 0; }
.logo {
  font-family: 'DM Serif Display', serif;
  font-size: 17px; color: var(--violet); white-space: nowrap;
  margin-right: 4px; flex-shrink: 0;
}
.tb-sep { width: 1px; height: 20px; background: var(--line); flex-shrink: 0; margin: 0 2px; }
.tb-btn {
  display: flex; align-items: center; gap: 4px;
  padding: 5px 9px; border: 1px solid var(--line2);
  border-radius: var(--r); background: var(--card);
  font-family: 'DM Sans', sans-serif; font-size: 11px;
  font-weight: 500; color: var(--ink2); cursor: pointer;
  transition: all .15s; white-space: nowrap; flex-shrink: 0;
}
.tb-btn:hover { border-color: var(--violet); color: var(--violet); background: var(--violet-light); }
.tb-btn.active { background: var(--violet); color: #fff; border-color: var(--violet); }
.tb-btn.danger:hover { border-color: var(--red); color: var(--red); background: #fef2f2; }
.tb-icon { font-size: 13px; }
.seg { display: flex; border: 1px solid var(--line2); border-radius: var(--r); overflow: hidden; flex-shrink: 0; }
.seg .tb-btn { border: none; border-radius: 0; border-right: 1px solid var(--line2); }
.seg .tb-btn:last-child { border-right: none; }

/* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
#body { display: flex; flex: 1; overflow: hidden; min-height: 0; }

/* ‚îÄ‚îÄ‚îÄ LIBRARY PANEL ‚îÄ‚îÄ‚îÄ */
#lib {
  width: 200px; min-width: 200px; background: var(--card);
  border-right: 1px solid var(--line); display: flex;
  flex-direction: column; overflow: hidden;
  transition: width .25s, min-width .25s;
  z-index: 100;
}
#lib.closed { width: 0; min-width: 0; }
#lib-head {
  padding: 10px 10px 8px; border-bottom: 1px solid var(--line);
  display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
}
#lib-head span { font-size: 10px; font-weight: 600; letter-spacing: .06em; text-transform: uppercase; color: var(--ink3); }
#lib-head-btns { display: flex; gap: 3px; }
#lib-tree { flex: 1; overflow-y: auto; padding: 4px 0; }
.lib-empty { padding: 16px 12px; font-size: 12px; color: var(--ink3); font-style: italic; text-align: center; }
.lib-footer { padding: 7px 8px; border-top: 1px solid var(--line); display: flex; gap: 4px; }
.lib-footer .tb-btn { flex: 1; justify-content: center; font-size: 10px; padding: 4px 6px; }

/* Library drag-drop */
.lib-row {
  display: flex; align-items: center; gap: 5px;
  padding: 5px 8px 5px 10px; cursor: pointer;
  border-left: 2.5px solid transparent;
  transition: background .1s, border-color .1s;
  position: relative;
}
.lib-row:hover { background: var(--paper); }
.lib-row.active { background: var(--violet-light); border-left-color: var(--violet); }
.lib-row.drag-over-folder { background: var(--violet-light); border-left-color: var(--violet); }
.lib-row.chart-row { padding-left: 24px; }
.lib-row-icon { font-size: 12px; flex-shrink: 0; }
.lib-row-name { font-size: 12px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.lib-row-acts { display: flex; gap: 1px; opacity: 0; flex-shrink: 0; }
.lib-row:hover .lib-row-acts { opacity: 1; }
.lib-row-acts button {
  background: none; border: none; cursor: pointer; color: var(--ink3);
  font-size: 11px; padding: 2px 3px; border-radius: 3px; line-height: 1;
}
.lib-row-acts button:hover { color: var(--ink); background: var(--line); }
.lib-drag-handle { cursor: grab; color: var(--ink3); font-size: 10px; flex-shrink: 0; opacity: 0; }
.lib-row:hover .lib-drag-handle { opacity: 1; }

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
#sidebar {
  width: 230px; min-width: 230px; background: var(--card);
  border-left: 1px solid var(--line); display: flex;
  flex-direction: column; overflow: hidden;
  transition: width .25s, min-width .25s;
  z-index: 100;
}
#sidebar.closed { width: 0; min-width: 0; }
#sidebar-inner { flex: 1; overflow-y: auto; }
.panel-section { padding: 10px 12px; border-bottom: 1px solid var(--line); }
.panel-title { font-size: 10px; font-weight: 600; letter-spacing: .06em; text-transform: uppercase; color: var(--ink3); margin-bottom: 8px; }
.rt-row { display: flex; align-items: center; gap: 6px; padding: 4px 6px; border-radius: var(--r); }
.rt-row:hover { background: var(--paper); }
.rt-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.rt-name { font-size: 12px; flex: 1; }
.rt-acts { opacity: 0; display: flex; gap: 2px; }
.rt-row:hover .rt-acts { opacity: 1; }
.rt-acts button { background: none; border: none; cursor: pointer; color: var(--ink3); font-size: 11px; padding: 2px; border-radius: 3px; }
.rt-acts button:hover { color: var(--red); }
.add-rt { display: flex; gap: 5px; margin-top: 8px; align-items: center; }
.add-rt input[type=text] { flex: 1; background: var(--paper); border: 1px solid var(--line2); border-radius: var(--r); color: var(--ink); font-size: 12px; padding: 5px 7px; outline: none; font-family: 'DM Sans', sans-serif; }
.add-rt input[type=text]:focus { border-color: var(--violet); }
.add-rt input[type=color] { width: 28px; height: 28px; border: 1px solid var(--line2); border-radius: var(--r); padding: 2px; cursor: pointer; background: var(--paper); }
.filter-row { display: flex; align-items: center; gap: 6px; padding: 4px 6px; border-radius: var(--r); cursor: pointer; font-size: 12px; }
.filter-row:hover { background: var(--paper); }
.char-row { display: flex; align-items: center; gap: 7px; padding: 5px 6px; border-radius: var(--r); cursor: grab; }
.char-row:hover { background: var(--paper); }
.char-row.active { background: var(--violet-light); }
.char-thumb { width: 26px; height: 26px; border-radius: 50%; background: var(--paper); border: 1px solid var(--line); object-fit: cover; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 10px; color: var(--ink3); overflow: hidden; }
.char-row-name { font-size: 12px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.char-row-acts { opacity: 0; display: flex; gap: 2px; }
.char-row:hover .char-row-acts { opacity: 1; }
.char-row-acts button { background: none; border: none; cursor: pointer; color: var(--ink3); font-size: 11px; padding: 2px; border-radius: 3px; }
.char-row-acts button:hover { color: var(--ink); }

/* ‚îÄ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ‚îÄ */
#canvas-wrap {
  flex: 1; position: relative; overflow: hidden;
  background: var(--paper);
}
#canvas-wrap::before {
  content: ''; position: absolute; inset: 0; pointer-events: none;
  background-image: radial-gradient(circle, #c4c4c4 0.8px, transparent 0.8px);
  background-size: 28px 28px;
  opacity: 0.4;
}
#canvas { width: 100%; height: 100%; position: absolute; inset: 0; touch-action: none; }
#canvas-transform { transform-origin: 0 0; }
#edit-badge {
  position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
  background: rgba(124,58,237,.08); border: 1px solid rgba(124,58,237,.2);
  border-radius: 20px; padding: 3px 12px; font-size: 10px; font-weight: 600;
  letter-spacing: .08em; text-transform: uppercase; color: var(--violet);
  pointer-events: none; white-space: nowrap;
}
#empty-state {
  position: absolute; inset: 0; display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 8px; pointer-events: none;
}
#empty-state .big { font-size: 40px; opacity: .12; }
#empty-state p { color: var(--ink3); font-size: 13px; }
#empty-state small { color: var(--ink3); font-size: 11px; opacity: .7; }
#chart-label {
  position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%);
  background: var(--card); border: 1px solid var(--line); border-radius: 20px;
  padding: 4px 14px; font-size: 11px; font-weight: 500; color: var(--ink3);
  box-shadow: var(--sh); pointer-events: none; white-space: nowrap;
}
#zoom-controls {
  position: absolute; bottom: 12px; right: 12px;
  display: flex; flex-direction: column; gap: 4px;
}
.zoom-btn {
  width: 32px; height: 32px; background: var(--card); border: 1px solid var(--line2);
  border-radius: var(--r); display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 16px; color: var(--ink2); box-shadow: var(--sh);
  transition: all .15s;
}
.zoom-btn:hover { border-color: var(--violet); color: var(--violet); }
#save-flash {
  position: absolute; top: 10px; right: 10px;
  background: #f0fdf4; border: 1px solid #86efac; border-radius: var(--r);
  padding: 3px 10px; font-size: 10px; font-weight: 600; color: var(--green);
  opacity: 0; transition: opacity .4s; pointer-events: none;
}
#save-flash.on { opacity: 1; }

/* ‚îÄ‚îÄ‚îÄ SVG NODE STYLES ‚îÄ‚îÄ‚îÄ */
.node-bg { fill: #fff; }
.node-stroke { fill: none; stroke-width: 2.5; }
.node-shadow { fill: rgba(0,0,0,.07); }
.node-name-text { font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; fill: var(--ink); text-anchor: middle; pointer-events: none; }
.anchor-dot { fill: var(--violet); stroke: #fff; stroke-width: 2; cursor: crosshair; opacity: 0; transition: opacity .15s r .1s; }
.node-dim { opacity: 0.18; transition: opacity .2s; }
.node-hl { transition: opacity .2s; }
.node-g:hover .anchor-dot { opacity: .9; }
.ctrl-handle { fill: var(--violet); stroke: #fff; stroke-width: 2; cursor: move; }
.ctrl-guide { stroke: var(--violet); stroke-width: 1; stroke-dasharray: 4 3; fill: none; opacity: .5; pointer-events: none; }
.link-hit { stroke: transparent; stroke-width: 24; fill: none; cursor: pointer; }
.act-btn { cursor: pointer; opacity: 0; transition: opacity .12s; }
.node-g:hover .act-btn { opacity: 1; }

/* ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ */
.modal-back {
  position: fixed; inset: 0; background: rgba(0,0,0,.25);
  display: none; align-items: center; justify-content: center;
  z-index: 1000; backdrop-filter: blur(4px); padding: 16px;
}
.modal-back.on { display: flex; }
.modal {
  background: var(--card); border: 1px solid var(--line);
  border-radius: var(--r2); padding: 22px; width: 100%; max-width: 460px;
  box-shadow: var(--sh2); max-height: 90dvh; overflow-y: auto;
}
.modal.wide { max-width: 540px; }
.modal h2 { font-family: 'DM Serif Display', serif; font-size: 17px; color: var(--ink); margin-bottom: 18px; }
.field { display: flex; flex-direction: column; gap: 4px; margin-bottom: 14px; }
.field label { font-size: 10px; font-weight: 600; letter-spacing: .07em; text-transform: uppercase; color: var(--ink3); }
.field input[type=text], .field select, .field textarea { background: var(--paper); border: 1px solid var(--line2); border-radius: var(--r); color: var(--ink); font-family: 'DM Sans', sans-serif; font-size: 13px; padding: 8px 10px; outline: none; width: 100%; }
.field input:focus, .field select:focus { border-color: var(--violet); }
.macts { display: flex; gap: 8px; justify-content: flex-end; margin-top: 18px; }
.av-wrap { display: flex; flex-direction: column; align-items: center; gap: 8px; margin-bottom: 16px; }
.av-img { width: 84px; height: 84px; border-radius: 50%; object-fit: cover; border: 2px solid var(--line); }
.upload-lbl { display: inline-flex; align-items: center; gap: 5px; font-size: 11px; color: var(--ink3); padding: 6px 12px; border: 1px dashed var(--line2); border-radius: var(--r); cursor: pointer; transition: all .15s; }
.upload-lbl:hover { border-color: var(--violet); color: var(--violet); }
.section-sub { font-size: 10px; font-weight: 600; letter-spacing: .07em; text-transform: uppercase; color: var(--ink3); margin: 10px 0 6px; }

/* ‚îÄ‚îÄ‚îÄ FLAG PICKER ‚îÄ‚îÄ‚îÄ */
.flag-grid { display: flex; flex-wrap: wrap; align-items: flex-start; align-content: flex-start; gap: 6px; margin-top: 4px; max-height: 160px; overflow-y: auto; padding: 2px; }
.flag-thumb {
  cursor: pointer; border-radius: 5px; overflow: hidden;
  border: 2.5px solid transparent; transition: all .15s;
  position: relative; aspect-ratio: 5/3;
}
.flag-thumb img, .flag-thumb svg { width: 100%; height: 100%; object-fit: cover; display: block; }
.flag-thumb.on { border-color: var(--violet); box-shadow: 0 0 0 2px var(--violet-light); }
.flag-thumb .fl { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,.55); color: #fff; font-size: 7px; text-align: center; padding: 1px; opacity: 0; transition: opacity .15s; }
.flag-thumb:hover .fl { opacity: 1; }
.flag-del-btn { position: absolute; top: 1px; right: 1px; background: rgba(220,38,38,.8); color: #fff; border: none; border-radius: 3px; font-size: 9px; padding: 1px 3px; cursor: pointer; opacity: 0; transition: opacity .15s; line-height: 1; }
.flag-thumb:hover .flag-del-btn { opacity: 1; }

/* ‚îÄ‚îÄ‚îÄ LINK MODAL ‚îÄ‚îÄ‚îÄ */
.lt-list { display: flex; flex-direction: column; gap: 5px; max-height: 260px; overflow-y: auto; }
.lt-row { display: flex; align-items: center; gap: 8px; padding: 7px 10px; border-radius: var(--r); border: 1.5px solid var(--line); cursor: pointer; transition: all .12s; }
.lt-row:hover { background: var(--paper); }
.lt-row.on { background: var(--violet-light); border-color: var(--violet); }
.lt-swatch { width: 11px; height: 11px; border-radius: 50%; flex-shrink: 0; }
.lt-label { font-size: 12px; flex: 1; font-weight: 500; }
.arr-btns { display: flex; gap: 3px; margin-left: auto; }
.ab { padding: 3px 7px; border: 1px solid var(--line2); border-radius: 4px; background: var(--paper); font-size: 11px; cursor: pointer; transition: all .12s; font-weight: 500; }
.ab.on { border-color: var(--violet); background: var(--violet-light); color: var(--violet); }

/* ‚îÄ‚îÄ‚îÄ BORDER PICKER ‚îÄ‚îÄ‚îÄ */
.border-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.border-swatch { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all .12s; flex-shrink: 0; }
.border-swatch.on { box-shadow: 0 0 0 2px var(--violet); }

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
#toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1c1917; color: #fff; padding: 8px 18px; border-radius: 20px; font-size: 12px; font-weight: 500; opacity: 0; transition: opacity .25s; z-index: 2000; pointer-events: none; white-space: nowrap; }
#toast.on { opacity: 1; }
#tip.on { opacity: 1; }

/* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
@media (max-width: 700px) {
  #lib { display: none; }
  #sidebar { width: 100%; min-width: unset; position: fixed; right: -100%; top: 48px; bottom: 0; transition: right .3s; z-index: 300; border-left: none; border-top: 1px solid var(--line); box-shadow: var(--sh2); }
  #sidebar.mobile-open { right: 0; }
  #mobile-side-btn { display: flex !important; }
  .tb-sep { display: none; }
}
#mobile-side-btn { display: none; }
</style>
</head>
<body>

<!-- TOP BAR -->
<div id="topbar">
  <span class="logo">OCs Relationship Chart</span>
  <div class="seg">
    <button class="tb-btn active" id="btn-edit" onclick="setMode('edit')">‚úèÔ∏è Edit</button>
    <button class="tb-btn" id="btn-view" onclick="setMode('view')">üëÅ View</button>
  </div>
  <div class="tb-sep"></div>
  <button class="tb-btn" id="btn-addchar" onclick="openCharModal()"><span class="tb-icon">Ôºã</span> Character</button>
  <button class="tb-btn" id="btn-names" onclick="toggleNames()">üè∑ Names</button>
  <button class="tb-btn" onclick="autoLayout()">‚äô Circle</button>
  <button class="tb-btn" onclick="fitView()">‚§¢ Fit</button>
  <div class="tb-sep"></div>
  <button class="tb-btn" onclick="saveCurrentChart()">üíæ Save</button>
  <button class="tb-btn" onclick="exportChart()">‚Üë Export</button>
  <button class="tb-btn" onclick="document.getElementById('import-inp').click()">‚Üì Import</button>
  <input type="file" id="import-inp" accept=".json" style="display:none" onchange="importFile(this)">
  <div class="tb-sep"></div>
  <button class="tb-btn" id="mobile-side-btn" onclick="document.getElementById('sidebar').classList.toggle('mobile-open')">‚ò∞</button>
  <button class="tb-btn" onclick="document.getElementById('lib').classList.toggle('closed')">üìö</button>
</div>

<!-- BODY -->
<div id="body">

  <!-- LIBRARY -->
  <div id="lib">
    <div id="lib-head">
      <span>Library</span>
      <div id="lib-head-btns">
        <button class="tb-btn" style="padding:3px 7px;font-size:10px;" onclick="newFolder()">+ Folder</button>
        <button class="tb-btn" style="padding:3px 7px;font-size:10px;" onclick="newChart()">+ Chart</button>
      </div>
    </div>
    <div id="lib-tree"></div>
    <div class="lib-footer">
      <button class="tb-btn" onclick="exportLibrary()">‚Üë Export All</button>
      <button class="tb-btn" onclick="document.getElementById('import-lib-inp').click()">‚Üì Import</button>
      <input type="file" id="import-lib-inp" accept=".json" style="display:none" onchange="importLibrary(this)">
      <button class="tb-btn" onclick="openFlagManager()" title="Manage pride flag images" style="flex-shrink:0;">üè≥</button>
    </div>
  </div>

  <!-- CANVAS -->
  <div id="canvas-wrap">
    <svg id="canvas">
      <defs></defs>
      <g id="canvas-transform">
        <g id="links-layer"></g>
        <g id="nodes-layer"></g>
      </g>
    </svg>
    <div id="edit-badge">Edit Mode</div>
    <div id="empty-state"><div class="big">‚óé</div><p>No chart open</p><small>Create or select a chart in the library</small></div>
    <div id="chart-label" style="display:none"></div>
    <div id="save-flash">Saved ‚úì</div>
    <div id="zoom-controls">
      <div class="zoom-btn" onclick="adjustZoom(0.2)">+</div>
      <div class="zoom-btn" onclick="fitView()">‚§¢</div>
      <div class="zoom-btn" onclick="adjustZoom(-0.2)">‚àí</div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <div id="sidebar-inner">
      <div class="panel-section">
        <div class="panel-title">Relationship Types</div>
        <div id="rt-list"></div>
        <div class="add-rt" id="add-rt-wrap">
          <input type="text" id="new-rt-name" placeholder="New type‚Ä¶" maxlength="24">
          <input type="color" id="new-rt-color" value="#7c3aed">
          <button class="tb-btn" style="padding:5px 8px;" onclick="addRelType()">+</button>
        </div>
      </div>
      <div class="panel-section" id="filter-sec" style="display:none">
        <div class="panel-title">Filter Relationships</div>
        <div id="filter-list"></div>
        <div style="display:flex;gap:5px;margin-top:8px;">
          <button class="tb-btn" style="flex:1;font-size:10px;" onclick="filterAll(true)">All</button>
          <button class="tb-btn" style="flex:1;font-size:10px;" onclick="filterAll(false)">None</button>
        </div>
      </div>
      <div class="panel-section">
        <div class="panel-title">Characters</div>
        <div id="char-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- CHARACTER MODAL -->
<div class="modal-back" id="char-modal" onclick="if(event.target===this)closeModal('char-modal')">
  <div class="modal wide">
    <h2 id="char-modal-title">New Character</h2>
    <div class="av-wrap">
      <img class="av-img" id="av-preview" src="" style="display:none">
      <div id="av-ph" style="width:84px;height:84px;border-radius:50%;background:var(--paper);border:2px solid var(--line);display:flex;align-items:center;justify-content:center;font-size:32px;">üë§</div>
      <label class="upload-lbl" for="av-inp">üì∑ Upload photo<input type="file" id="av-inp" accept="image/*" style="display:none" onchange="handleAvImg(this)"></label>
    </div>
    <div class="field"><label>Name</label><input type="text" id="char-name-inp" placeholder="Character name‚Ä¶" maxlength="32"></div>
    <div class="field">
      <label>Profile Border</label>
      <div class="border-row" id="border-row">
        <div class="border-swatch on" data-bc="none" style="background:var(--paper);border-color:var(--line2);" title="None" onclick="setBorderColor('none',this)">‚úï</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-top:6px;">
        <span style="font-size:11px;color:var(--ink3);">Custom color:</span>
        <input type="color" id="border-color-inp" value="#7c3aed" style="width:32px;height:26px;border:1px solid var(--line2);border-radius:4px;padding:2px;cursor:pointer;" onchange="setBorderColor(this.value,null)">
        <span style="font-size:11px;color:var(--ink3);">Width:</span>
        <select id="border-width-inp" style="font-size:12px;padding:3px 6px;border:1px solid var(--line2);border-radius:4px;background:var(--paper);outline:none;">
          <option value="2">Thin</option>
          <option value="4" selected>Normal</option>
          <option value="7">Thick</option>
        </select>
      </div>
    </div>
    <div class="field">
      <label>Pride Flags ‚Äî top-left corner (up to 3)</label>
      <div id="flag-grid-wrap">
        <div class="flag-grid" id="flag-grid"></div>
        <div id="flag-empty" style="display:none;padding:12px;text-align:center;font-size:12px;color:var(--ink3);border:1px dashed var(--line2);border-radius:var(--r);margin-top:4px;">
          No flags uploaded yet.<br>
          <span style="font-size:11px;">Use "üè≥ Manage Flags" in the library to add images.</span>
        </div>
      </div>
      <div id="flag-sel-info" style="font-size:10px;color:var(--ink3);margin-top:5px;"></div>
    </div>
    <div class="macts">
      <button class="tb-btn" onclick="closeCharModal()">Cancel</button>
      <button class="tb-btn active" onclick="saveChar()">Save</button>
    </div>
  </div>
</div>

<!-- LINK MODAL -->
<div class="modal-back" id="link-modal" onclick="if(event.target===this)closeModal('link-modal')">
  <div class="modal">
    <h2>Edit Connection</h2>
    <div class="field">
      <label>Relationship Types</label>
      <div class="lt-list" id="lt-list"></div>
    </div>
    <div class="macts">
      <button class="tb-btn danger" style="margin-right:auto;" onclick="deleteLinkModal()">Delete</button>
      <button class="tb-btn" onclick="closeLinkModal()">Cancel</button>
      <button class="tb-btn active" onclick="saveLinkModal()">Save</button>
    </div>
  </div>
</div>

<!-- SAVE MODAL -->
<div class="modal-back" id="save-modal" onclick="if(event.target===this)closeModal('save-modal')">
  <div class="modal">
    <h2>Save Chart</h2>
    <div class="field"><label>Name</label><input type="text" id="save-name-inp" placeholder="Chart name‚Ä¶" maxlength="40"></div>
    <div class="field"><label>Folder (optional)</label><select id="save-folder-sel"><option value="">‚Äî No folder ‚Äî</option></select></div>
    <div class="macts">
      <button class="tb-btn" onclick="document.getElementById('save-modal').classList.remove('on')">Cancel</button>
      <button class="tb-btn active" onclick="confirmSave()">Save</button>
    </div>
  </div>
</div>

<!-- FOLDER MODAL -->
<div class="modal-back" id="folder-modal" onclick="if(event.target===this)closeModal('folder-modal')">
  <div class="modal">
    <h2>New Folder</h2>
    <div class="field"><label>Name</label><input type="text" id="folder-name-inp" maxlength="40"></div>
    <div class="macts">
      <button class="tb-btn" onclick="document.getElementById('folder-modal').classList.remove('on')">Cancel</button>
      <button class="tb-btn active" onclick="confirmFolder()">Create</button>
    </div>
  </div>
</div>

<!-- RENAME / INPUT MODAL (replaces prompt() for names) -->
<div class="modal-back" id="name-modal" onclick="if(event.target===this)closeModal('name-modal')">
  <div class="modal">
    <h2 id="name-modal-title">Rename</h2>
    <div class="field"><label>Name</label><input type="text" id="name-modal-inp" maxlength="40"></div>
    <div class="macts">
      <button class="tb-btn" onclick="document.getElementById('name-modal').classList.remove('on');_nameModalCb=null;">Cancel</button>
      <button class="tb-btn active" onclick="confirmNameModal()">OK</button>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-back" id="confirm-modal" onclick="if(event.target===this)_confirmModalCb&&_confirmModalCb(false)">
  <div class="modal">
    <h2 id="confirm-modal-title">Are you sure?</h2>
    <p id="confirm-modal-msg" style="font-size:13px;color:var(--ink2);margin-bottom:4px;line-height:1.5;"></p>
    <div class="macts">
      <button class="tb-btn" onclick="resolveConfirm(false)">Cancel</button>
      <button class="tb-btn danger" id="confirm-modal-ok" onclick="resolveConfirm(true)">Delete</button>
    </div>
  </div>
</div>

<div class="modal-back" id="flag-manager" onclick="if(event.target===this)closeFlagEdit()">
  <div class="modal wide" style="position:relative;">
    <h2>üè≥ Flag Library</h2>
    <p style="font-size:12px;color:var(--ink3);margin-bottom:14px;line-height:1.5;">Upload your own pride flag images here. They become available across all charts. Click any flag to edit or delete it.</p>
    <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center;">
      <label class="upload-lbl" for="flag-manager-inp" style="display:inline-flex;">
        + Upload flag image(s)
        <input type="file" id="flag-manager-inp" accept="image/*" multiple style="display:none" onchange="uploadFlagsFromManager(this)">
      </label>
      <span style="font-size:11px;color:var(--ink3);">or paste URL:</span>
      <div style="display:flex;flex:1;gap:6px;min-width:200px;">
        <input type="text" id="flag-url-inp" placeholder="https://example.com/flag.png" style="flex:1;background:var(--paper);border:1px solid var(--line2);border-radius:var(--r);color:var(--ink);font-size:12px;padding:5px 8px;outline:none;font-family:'DM Sans',sans-serif;" onkeydown="if(event.key==='Enter')addFlagFromUrl()">
        <button class="tb-btn" onclick="addFlagFromUrl()" style="white-space:nowrap;">Add</button>
      </div>
    </div>
    <div id="flag-manager-grid" style="display:flex;flex-wrap:wrap;align-items:flex-start;align-content:flex-start;gap:8px;max-height:52vh;overflow-y:auto;padding:4px 2px;"></div>
    <div id="flag-manager-empty" style="display:none;padding:24px;text-align:center;color:var(--ink3);font-size:13px;border:1px dashed var(--line2);border-radius:var(--r);">
      No flags yet ‚Äî upload some above!
    </div>
    <div class="macts">
      <button class="tb-btn active" onclick="document.getElementById('flag-manager').classList.remove('on');closeFlagEdit()">Done</button>
    </div>
    <!-- Flag edit popover -->
    <div id="flag-edit-pop" style="display:none;position:absolute;z-index:10;background:var(--card);border:1px solid var(--line2);border-radius:var(--r2);box-shadow:var(--sh2);padding:12px;width:200px;">
      <div style="font-size:10px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--ink3);margin-bottom:8px;">Edit Flag</div>
      <input type="text" id="fep-name" maxlength="40" placeholder="Flag name‚Ä¶" style="width:100%;background:var(--paper);border:1px solid var(--line2);border-radius:var(--r);color:var(--ink);font-family:'DM Sans',sans-serif;font-size:12px;padding:6px 8px;outline:none;margin-bottom:8px;" onkeydown="if(event.key==='Enter')saveFlagEdit();if(event.key==='Escape')closeFlagEdit();">
      <label class="upload-lbl" style="display:flex;justify-content:center;margin-bottom:8px;font-size:11px;">
        üñº Replace image
        <input type="file" accept="image/*" style="display:none" onchange="replaceFlagImg(this)">
      </label>
      <div style="display:flex;gap:6px;">
        <button class="tb-btn danger" style="flex:1;font-size:11px;justify-content:center;" onclick="deleteFlagEdit()">Delete</button>
        <button class="tb-btn" style="flex:1;font-size:11px;justify-content:center;" onclick="closeFlagEdit()">Cancel</button>
        <button class="tb-btn active" style="flex:1;font-size:11px;justify-content:center;" onclick="saveFlagEdit()">Save</button>
      </div>
    </div>
  </div>
</div>

<div id="tip" style="position:fixed;background:var(--card);border:1px solid var(--line);padding:4px 9px;border-radius:var(--r);font-size:11px;font-weight:500;pointer-events:none;opacity:0;transition:opacity .12s;z-index:1999;color:var(--ink);box-shadow:var(--sh);white-space:nowrap;"></div>
<div id="toast"></div>

<script>
// Flags are purely user-uploaded images stored in LIB.customFlags
// No built-in flags ‚Äî everything comes from the global flag library

const BORDER_PRESETS=['none','#7c3aed','#e63a7a','#3aa8e6','#e67e3a','#3aad5c','#1c1917','#fbbf24','#f43f5e'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIBRARY & CHART STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LS_KEY='charweb_v3';
let LIB={folders:[],charts:[],customFlags:[]};
let CID=null; // current chart id

let G={
  mode:'edit', showNames:true,
  chars:[], links:[],
  relTypes:[
    {id:'family', name:'Family',  color:'#e67e3a'},
    {id:'friends',name:'Friends', color:'#3aa8e6'},
    {id:'like',   name:'Like',    color:'#e63a7a'},
    {id:'dislike',name:'Dislike', color:'#dc2626'},
    {id:'respect',name:'Respect', color:'#3aad5c'},
    {id:'rivals', name:'Rivals',  color:'#c4a020'},
  ],
  filters:{}, selChar:null, selLink:null,
  pImg:null, pFlags:[], pBorderColor:'none', pBorderWidth:4, editCid:null,
};

// ‚îÄ‚îÄ‚îÄ viewport transform ‚îÄ‚îÄ‚îÄ
let vp={x:0,y:0,scale:1};
const NR=48; // node radius
const LINK_GAP=10; // gap between link endpoint and node edge

// ‚îÄ‚îÄ‚îÄ drag state ‚îÄ‚îÄ‚îÄ
let dragNode=null, dragAnchor=null, dragCP=null, hasDragged=false;
let editLinkId=null;
let panState=null;
let pinchState=null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PERSISTENCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadLib(){try{const d=localStorage.getItem(LS_KEY);if(d){const p=JSON.parse(d);LIB=p.lib||LIB;if(p.lastCid){CID=p.lastCid;const c=LIB.charts.find(x=>x.id===CID);if(c)loadChartData(c.data);}}}catch(e){}}
function persistLib(){try{localStorage.setItem(LS_KEY,JSON.stringify({lib:LIB,lastCid:CID}));}catch(e){toast('Storage full ‚Äî export to save.');}}
function autoSave(){if(!CID)return;const c=LIB.charts.find(x=>x.id===CID);if(c){c.data=snapshotChart();persistLib();flashSave();}}
function flashSave(){const el=document.getElementById('save-flash');el.classList.add('on');setTimeout(()=>el.classList.remove('on'),1400);}

function snapshotChart(){return{chars:G.chars,links:G.links,relTypes:G.relTypes,showNames:G.showNames,customFlags:LIB.customFlags};}
function loadChartData(d){G.chars=d.chars||[];G.links=d.links||[];G.relTypes=d.relTypes||defaultRelTypes();G.showNames=d.showNames!==undefined?d.showNames:true;if(d.customFlags){d.customFlags.forEach(f=>{if(!LIB.customFlags.find(x=>x.id===f.id))LIB.customFlags.push(f);});}G.filters={};G.selChar=null;G.selLink=null;}
function defaultRelTypes(){return[{id:'family',name:'Family',color:'#e67e3a'},{id:'friends',name:'Friends',color:'#3aa8e6'},{id:'like',name:'Like',color:'#e63a7a'},{id:'dislike',name:'Dislike',color:'#dc2626'},{id:'respect',name:'Respect',color:'#3aad5c'},{id:'rivals',name:'Rivals',color:'#c4a020'}];}
function blankChart(){return{chars:[],links:[],relTypes:defaultRelTypes(),showNames:true};}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIBRARY UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLib(){
  const tree=document.getElementById('lib-tree'); tree.innerHTML='';
  const loose=LIB.charts.filter(c=>!c.folderId);
  loose.forEach(c=>tree.appendChild(makeChartRow(c)));
  LIB.folders.forEach(f=>{
    const fr=document.createElement('div');
    fr.className='lib-row'+(CID&&LIB.charts.find(c=>c.id===CID)?.folderId===f.id?' active':'');
    fr.draggable=true;
    fr.dataset.fid=f.id;
    fr.innerHTML=`<span class="lib-drag-handle">‚†ø</span><span class="lib-row-icon">üìÅ</span>
    <span class="lib-row-name">${esc(f.name)}</span>
    <span class="lib-row-acts">
      <button title="Export folder" onclick="event.stopPropagation();exportFolder('${f.id}')">‚Üë</button>
      <button title="Duplicate" onclick="event.stopPropagation();duplicateFolder('${f.id}')">‚ßâ</button>
      <button title="Rename" onclick="event.stopPropagation();renameFolder('${f.id}')">‚úé</button>
      <button title="Delete" onclick="event.stopPropagation();deleteFolder('${f.id}')">‚úï</button>
    </span>`;
    fr.addEventListener('dragover',e=>{e.preventDefault();fr.classList.add('drag-over-folder');});
    fr.addEventListener('dragleave',()=>fr.classList.remove('drag-over-folder'));
    fr.addEventListener('drop',e=>{e.preventDefault();fr.classList.remove('drag-over-folder');const cid=e.dataTransfer.getData('chartId');if(cid){const c=LIB.charts.find(x=>x.id===cid);if(c){c.folderId=f.id;persistLib();renderLib();}}});
    setupLibDrag(fr,'folder',f.id);
    tree.appendChild(fr);
    LIB.charts.filter(c=>c.folderId===f.id).forEach(c=>tree.appendChild(makeChartRow(c)));
  });
  if(!loose.length&&!LIB.folders.length) tree.innerHTML='<div class="lib-empty">No charts yet</div>';
}

function makeChartRow(c){
  const row=document.createElement('div');
  row.className='lib-row chart-row'+(CID===c.id?' active':'');
  row.draggable=true;
  row.dataset.cid=c.id;
  row.innerHTML=`<span class="lib-drag-handle">‚†ø</span><span class="lib-row-icon">‚óé</span>
  <span class="lib-row-name">${esc(c.name)}</span>
  <span class="lib-row-acts">
    <button title="Export" onclick="event.stopPropagation();exportChartById('${c.id}')">‚Üë</button>
    <button title="Duplicate" onclick="event.stopPropagation();duplicateChart('${c.id}')">‚ßâ</button>
    <button title="Rename" onclick="event.stopPropagation();renameChart('${c.id}')">‚úé</button>
    <button title="Delete" onclick="event.stopPropagation();deleteChart('${c.id}')">‚úï</button>
  </span>`;
  row.addEventListener('click',()=>loadChart(c.id));
  row.addEventListener('dragstart',e=>{e.dataTransfer.setData('chartId',c.id);e.dataTransfer.setData('type','chart');});
  setupLibDrag(row,'chart',c.id);
  return row;
}

// simple row reordering
function setupLibDrag(el,type,id){
  el.addEventListener('dragstart',e=>{e.dataTransfer.setData('dragType',type);e.dataTransfer.setData('dragId',id);});
}
document.addEventListener('DOMContentLoaded',()=>{
  const tree=document.getElementById('lib-tree');
  tree.addEventListener('dragover',e=>e.preventDefault());
  tree.addEventListener('drop',e=>{
    const type=e.dataTransfer.getData('dragType');
    const id=e.dataTransfer.getData('dragId');
    if(!type||!id)return;
    if(type==='chart'){
      const target=e.target.closest('.lib-row');
      if(target&&target.dataset.fid){
        const c=LIB.charts.find(x=>x.id===id);if(c){c.folderId=target.dataset.fid;persistLib();renderLib();}
        return;
      }
      // reorder
      const idx=LIB.charts.findIndex(x=>x.id===id); if(idx<0)return;
      const targetRow=e.target.closest('[data-cid]');
      if(targetRow&&targetRow.dataset.cid!==id){
        const tidx=LIB.charts.findIndex(x=>x.id===targetRow.dataset.cid);
        if(tidx>=0){const [item]=LIB.charts.splice(idx,1);LIB.charts.splice(tidx,0,item);persistLib();renderLib();}
      }
    } else if(type==='folder'){
      const idx=LIB.folders.findIndex(x=>x.id===id);if(idx<0)return;
      const targetRow=e.target.closest('[data-fid]');
      if(targetRow&&targetRow.dataset.fid!==id){
        const tidx=LIB.folders.findIndex(x=>x.id===targetRow.dataset.fid);
        if(tidx>=0){const [item]=LIB.folders.splice(idx,1);LIB.folders.splice(tidx,0,item);persistLib();renderLib();}
      }
    }
  });
});

let _nameModalCb=null;
function openNameModal(title,defaultVal,cb){
  _nameModalCb=cb;
  document.getElementById('name-modal-title').textContent=title;
  const inp=document.getElementById('name-modal-inp');inp.value=defaultVal||'';
  document.getElementById('name-modal').classList.add('on');
  setTimeout(()=>{inp.focus();inp.select();},60);
}
function confirmNameModal(){
  const n=document.getElementById('name-modal-inp').value.trim();
  document.getElementById('name-modal').classList.remove('on');
  if(n&&_nameModalCb)_nameModalCb(n);
  _nameModalCb=null;
}
document.addEventListener('keydown',e=>{if(e.key==='Enter'&&document.getElementById('name-modal').classList.contains('on'))confirmNameModal();});

function newChart(){openNameModal('New Chart','Untitled',name=>{const id='ch'+Date.now();LIB.charts.push({id,name,folderId:null,data:blankChart()});persistLib();loadChart(id);});}
function renameFolder(id){const f=LIB.folders.find(x=>x.id===id);if(!f)return;openNameModal('Rename Folder',f.name,n=>{f.name=n;persistLib();renderLib();});}
function renameChart(id){const c=LIB.charts.find(x=>x.id===id);if(!c)return;openNameModal('Rename Chart',c.name,n=>{c.name=n;persistLib();renderLib();updateChartLabel();});}
function duplicateChart(id){const c=LIB.charts.find(x=>x.id===id);if(!c)return;const data=JSON.parse(JSON.stringify(c.data));const newId='ch'+Date.now();openNameModal('Duplicate Chart',c.name+' (copy)',n=>{LIB.charts.push({id:newId,name:n,folderId:c.folderId,data});persistLib();renderLib();toast('Chart duplicated!');});}
function duplicateFolder(id){const f=LIB.folders.find(x=>x.id===id);if(!f)return;openNameModal('Duplicate Folder',f.name+' (copy)',n=>{const nfid='f'+Date.now();LIB.folders.push({id:nfid,name:n});LIB.charts.filter(c=>c.folderId===id).forEach(c=>{LIB.charts.push({id:'ch'+Date.now(),name:c.name,folderId:nfid,data:JSON.parse(JSON.stringify(c.data))});});persistLib();renderLib();toast('Folder duplicated!');});}
function newFolder(){document.getElementById('folder-modal').classList.add('on');document.getElementById('folder-name-inp').value='';setTimeout(()=>document.getElementById('folder-name-inp').focus(),60);}
function confirmFolder(){const n=document.getElementById('folder-name-inp').value.trim();if(!n)return;LIB.folders.push({id:'f'+Date.now(),name:n});persistLib();renderLib();document.getElementById('folder-modal').classList.remove('on');}
function deleteFolder(id){const f=LIB.folders.find(x=>x.id===id);openConfirm('Delete Folder',`Delete "${f?.name||'this folder'}" and all its charts? This cannot be undone.`,()=>{LIB.charts=LIB.charts.filter(c=>c.folderId!==id);LIB.folders=LIB.folders.filter(f=>f.id!==id);if(CID&&!LIB.charts.find(c=>c.id===CID)){CID=null;G=Object.assign({},G,blankChart());}persistLib();renderLib();renderAll();});}
function deleteChart(id){const c=LIB.charts.find(x=>x.id===id);openConfirm('Delete Chart',`Delete "${c?.name||'this chart'}"? This cannot be undone.`,()=>{LIB.charts=LIB.charts.filter(c=>c.id!==id);if(CID===id){CID=null;G=Object.assign({},G,...[blankChart()]);renderAll();}persistLib();renderLib();});}
function loadChart(id){autoSave();const c=LIB.charts.find(x=>x.id===id);if(!c)return;CID=id;loadChartData(c.data);persistLib();renderLib();renderAll();updateChartLabel();}
function updateChartLabel(){const c=LIB.charts.find(x=>x.id===CID);const el=document.getElementById('chart-label');if(c){el.textContent=c.name;el.style.display='';}else el.style.display='none';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT / IMPORT (JSON)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportChart(){
  if(CID){autoSave();exportChartById(CID);}
  else {const d={type:'charweb_chart',version:3,name:'Untitled',data:snapshotChart()};dlJSON(d,'chart.json');}
}
function exportChartById(id){const c=LIB.charts.find(x=>x.id===id);if(!c)return;if(id===CID)c.data=snapshotChart();dlJSON({type:'charweb_chart',version:3,name:c.name,data:c.data},c.name.replace(/\s+/g,'_')+'.json');}
function exportFolder(fid){const f=LIB.folders.find(x=>x.id===fid);if(!f)return;const charts=LIB.charts.filter(c=>c.folderId===fid).map(c=>{if(c.id===CID)c.data=snapshotChart();return c;});dlJSON({type:'charweb_folder',version:3,folder:{id:f.id,name:f.name},charts},'folder_'+f.name.replace(/\s+/g,'_')+'.json');}
function exportLibrary(){autoSave();LIB.charts.forEach(c=>{if(c.id===CID)c.data=snapshotChart();});dlJSON({type:'charweb_library',version:3,lib:LIB},'CharacterWeb_Library.json');toast('Library exported!');}
function dlJSON(obj,filename){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}));a.download=filename;a.click();}

function importFile(inp){readJSON(inp.files[0],obj=>{
  if(obj.type==='charweb_chart'){const id='ch'+Date.now();LIB.charts.push({id,name:obj.name||'Imported',folderId:null,data:obj.data});persistLib();loadChart(id);toast('Chart imported!');}
  else toast('Unknown format');
});inp.value='';}
function importLibrary(inp){readJSON(inp.files[0],obj=>{
  if(obj.type==='charweb_library'&&obj.lib){openConfirm('Import Library','Merge this library into your current one?',()=>{(obj.lib.folders||[]).forEach(f=>{if(!LIB.folders.find(x=>x.id===f.id))LIB.folders.push(f);});(obj.lib.charts||[]).forEach(c=>{if(!LIB.charts.find(x=>x.id===c.id))LIB.charts.push(c);});(obj.lib.customFlags||[]).forEach(f=>{if(!LIB.customFlags.find(x=>x.id===f.id))LIB.customFlags.push(f);});persistLib();renderLib();toast('Library merged!');});}
  else if(obj.type==='charweb_folder'){const nfid='f'+Date.now();LIB.folders.push({id:nfid,name:obj.folder?.name||'Imported'});(obj.charts||[]).forEach(c=>LIB.charts.push({id:'ch'+Date.now(),name:c.name,folderId:nfid,data:c.data}));persistLib();renderLib();toast('Folder imported!');}
  else if(obj.type==='charweb_chart'){const id='ch'+Date.now();LIB.charts.push({id,name:obj.name||'Imported',folderId:null,data:obj.data});persistLib();loadChart(id);toast('Chart imported!');}
  else toast('Unknown format');
});inp.value='';}
function readJSON(file,cb){if(!file)return;const r=new FileReader();r.onload=e=>{try{cb(JSON.parse(e.target.result));}catch(err){toast('Invalid JSON file');}};r.readAsText(file);}

function saveCurrentChart(){if(CID){autoSave();toast('Saved!');}else openSaveModal();}
function openSaveModal(){const sel=document.getElementById('save-folder-sel');sel.innerHTML='<option value="">‚Äî No folder ‚Äî</option>';LIB.folders.forEach(f=>sel.innerHTML+=`<option value="${f.id}">${esc(f.name)}</option>`);document.getElementById('save-name-inp').value='Untitled';document.getElementById('save-modal').classList.add('on');setTimeout(()=>document.getElementById('save-name-inp').focus(),60);}
function confirmSave(){const n=document.getElementById('save-name-inp').value.trim();if(!n)return;const fid=document.getElementById('save-folder-sel').value||null;const id='ch'+Date.now();LIB.charts.push({id,name:n,folderId:fid,data:snapshotChart()});CID=id;persistLib();renderLib();updateChartLabel();document.getElementById('save-modal').classList.remove('on');toast('Saved!');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FLAG LIBRARY ‚Äî global, upload-only
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openFlagManager(){
  renderFlagManager();
  document.getElementById('flag-manager').classList.add('on');
}

function addFlagFromUrl(){
  const inp=document.getElementById('flag-url-inp');const url=inp.value.trim();if(!url)return;
  const label=url.split('/').pop().replace(/[?#].*$/,'').replace(/\.[^.]+$/,'')||'Flag';
  const id='cf'+Date.now()+'_'+Math.random().toString(36).slice(2);
  const img=new Image();img.crossOrigin='anonymous';
  img.onload=()=>{try{const c=document.createElement('canvas');c.width=img.naturalWidth;c.height=img.naturalHeight;c.getContext('2d').drawImage(img,0,0);const dataUrl=c.toDataURL('image/png');LIB.customFlags.push({id,label,img:dataUrl});persistLib();renderFlagManager();buildFlagPicker();toast('Flag added!');inp.value='';}catch(e){LIB.customFlags.push({id,label,img:url});persistLib();renderFlagManager();buildFlagPicker();toast('Flag added (URL stored)!');inp.value='';}};
  img.onerror=()=>toast('Could not load image from that URL.');
  img.src=url;
}

// Flag edit popover
let _flagEditId=null;
function openFlagEdit(fid,anchorEl){
  _flagEditId=fid;
  const f=LIB.customFlags.find(x=>x.id===fid);if(!f)return;
  const pop=document.getElementById('flag-edit-pop');
  pop.querySelector('#fep-name').value=f.label;
  // Position relative to flag-manager modal content
  pop.style.display='block';
  requestAnimationFrame(()=>{
    const ar=anchorEl.getBoundingClientRect();
    const mr=document.querySelector('#flag-manager .modal');
    const mr2=mr.getBoundingClientRect();
    let left=ar.left-mr2.left;
    let top=ar.bottom-mr2.top+6;
    const pw=pop.offsetWidth||180;
    if(left+pw>mr2.width-8)left=mr2.width-pw-8;
    if(left<0)left=0;
    pop.style.left=left+'px';pop.style.top=top+'px';
    pop.querySelector('#fep-name').focus();pop.querySelector('#fep-name').select();
  });
}
function closeFlagEdit(){const pop=document.getElementById('flag-edit-pop');if(pop)pop.style.display='none';_flagEditId=null;}
function saveFlagEdit(){
  const f=LIB.customFlags.find(x=>x.id===_flagEditId);if(!f){closeFlagEdit();return;}
  const n=document.getElementById('fep-name').value.trim();if(n)f.label=n;
  persistLib();renderFlagManager();buildFlagPicker();closeFlagEdit();
}
function deleteFlagEdit(){
  openConfirm('Remove Flag','Remove this flag from the library? It will be removed from all characters.',()=>{removeFlag(_flagEditId);closeFlagEdit();});
}
function replaceFlagImg(inp){
  const f=LIB.customFlags.find(x=>x.id===_flagEditId);if(!f||!inp.files[0])return;
  const r=new FileReader();r.onload=e=>{f.img=e.target.result;persistLib();renderFlagManager();buildFlagPicker();inp.value='';const pop=document.getElementById('flag-edit-pop');if(pop.style.display!=='none'){const imgEl=pop.querySelector('img');if(imgEl)imgEl.src=e.target.result;}};r.readAsDataURL(inp.files[0]);
}

function renderFlagManager(){
  const grid=document.getElementById('flag-manager-grid');
  const empty=document.getElementById('flag-manager-empty');
  grid.innerHTML='';closeFlagEdit();
  if(!LIB.customFlags.length){grid.style.display='none';empty.style.display='';return;}
  grid.style.display='flex';empty.style.display='none';
  const FW=52,FH=32; // ~2x chart size (chart: 26x16)
  LIB.customFlags.forEach(f=>{
    const wrap=document.createElement('div');
    wrap.title=f.label;
    wrap.style.cssText=`width:${FW}px;height:${FH}px;border-radius:4px;overflow:hidden;border:1.5px solid var(--line);cursor:pointer;flex-shrink:0;transition:border-color .12s,box-shadow .12s;`;
    const img=document.createElement('img');
    img.src=f.img;img.alt=f.label;img.style.cssText='width:100%;height:100%;object-fit:cover;display:block;pointer-events:none;';
    wrap.appendChild(img);
    wrap.addEventListener('mouseenter',()=>{wrap.style.borderColor='var(--violet)';wrap.style.boxShadow='0 0 0 2px var(--violet-light)';});
    wrap.addEventListener('mouseleave',()=>{wrap.style.borderColor='var(--line)';wrap.style.boxShadow='';});
    wrap.addEventListener('click',()=>openFlagEdit(f.id,wrap));
    grid.appendChild(wrap);
  });
}

function uploadFlagsFromManager(inp){
  const files=[...inp.files];if(!files.length)return;inp.value='';
  let done=0;
  files.forEach(file=>{
    const r=new FileReader();
    r.onload=e=>{
      const label=file.name.replace(/\.[^.]+$/,'');
      LIB.customFlags.push({id:'cf'+Date.now()+'_'+Math.random().toString(36).slice(2),label,img:e.target.result});
      done++;
      if(done===files.length){persistLib();renderFlagManager();buildFlagPicker();toast(`${done} flag${done>1?'s':''} added!`);}
    };
    r.readAsDataURL(file);
  });
}

function uploadCustomFlag(inp){uploadFlagsFromManager(inp);}  // kept for any legacy refs

function removeFlag(id){
  openConfirm('Remove Flag','Remove this flag from the library? It will be removed from all characters.',()=>{
  LIB.customFlags=LIB.customFlags.filter(f=>f.id!==id);
  G.chars.forEach(c=>{if(c.flags)c.flags=c.flags.filter(fid=>fid!==id);});
  LIB.charts.forEach(c=>{if(c.data?.chars)c.data.chars.forEach(ch=>{if(ch.flags)ch.flags=ch.flags.filter(fid=>fid!==id);});});
  persistLib();renderFlagManager();buildFlagPicker();renderNodes();});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FLAG PICKER (inside character modal)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildFlagPicker(){
  const grid=document.getElementById('flag-grid');
  const empty=document.getElementById('flag-empty');
  if(!grid)return;
  grid.innerHTML='';
  if(!LIB.customFlags.length){grid.style.display='none';empty.style.display='';return;}
  grid.style.display='flex';empty.style.display='none';
  const FW=52,FH=32;
  LIB.customFlags.forEach(f=>{
    const th=document.createElement('div');th.dataset.fid=f.id;th.title=f.label;
    const sel=G.pFlags.includes(f.id);
    th.style.cssText=`width:${FW}px;height:${FH}px;border-radius:4px;overflow:hidden;border:2px solid ${sel?'var(--violet)':'var(--line)'};cursor:pointer;flex-shrink:0;transition:border-color .12s,box-shadow .12s;box-shadow:${sel?'0 0 0 2px var(--violet-light)':''};`;
    const img=document.createElement('img');img.src=f.img;img.alt=f.label;img.style.cssText='width:100%;height:100%;object-fit:cover;display:block;pointer-events:none;';
    th.appendChild(img);
    th.addEventListener('mouseenter',()=>{if(!G.pFlags.includes(f.id)){th.style.borderColor='var(--violet)';th.style.boxShadow='0 0 0 2px var(--violet-light)';}});
    th.addEventListener('mouseleave',()=>{if(!G.pFlags.includes(f.id)){th.style.borderColor='var(--line)';th.style.boxShadow='';}});
    th.addEventListener('click',()=>{
      const idx=G.pFlags.indexOf(f.id);
      if(idx>=0){G.pFlags.splice(idx,1);th.style.borderColor='var(--line)';th.style.boxShadow='';}
      else{
        if(G.pFlags.length>=3){const oldId=G.pFlags.shift();const oldEl=grid.querySelector(`[data-fid="${oldId}"]`);if(oldEl){oldEl.style.borderColor='var(--line)';oldEl.style.boxShadow='';}}
        G.pFlags.push(f.id);th.style.borderColor='var(--violet)';th.style.boxShadow='0 0 0 2px var(--violet-light)';
      }
      updateFlagInfo();
    });
    grid.appendChild(th);
  });
}

function updateFlagInfo(){
  document.getElementById('flag-sel-info').textContent=
    G.pFlags.length
      ? 'Selected: '+G.pFlags.map(id=>LIB.customFlags.find(f=>f.id===id)?.label||id).join(', ')
      : '';
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BORDER PRESETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildBorderPicker(){
  const row=document.getElementById('border-row');row.innerHTML='';
  BORDER_PRESETS.forEach(bc=>{
    const s=document.createElement('div');s.className='border-swatch';s.dataset.bc=bc;s.title=bc==='none'?'None':bc;
    if(bc==='none'){s.style.background='var(--paper)';s.style.borderColor='var(--line2)';s.style.display='flex';s.style.alignItems='center';s.style.justifyContent='center';s.style.fontSize='11px';s.style.color='var(--ink3)';s.textContent='‚úï';}
    else{s.style.background=bc;s.style.borderColor=bc;}
    s.addEventListener('click',()=>setBorderColor(bc,s));
    row.appendChild(s);
  });
}
function setBorderColor(color,el){
  G.pBorderColor=color;
  document.querySelectorAll('.border-swatch').forEach(s=>s.classList.remove('on'));
  if(el)el.classList.add('on');
  if(color!=='none'){document.getElementById('border-color-inp').value=color;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setMode(m){
  G.mode=m;G.selChar=null;G.selLink=null;
  document.getElementById('btn-edit').classList.toggle('active',m==='edit');
  document.getElementById('btn-view').classList.toggle('active',m==='view');
  document.getElementById('btn-addchar').style.display=m==='edit'?'':'none';
  document.getElementById('edit-badge').style.display=m==='edit'?'':'none';
  document.getElementById('add-rt-wrap').style.display=m==='edit'?'':'none';
  document.getElementById('filter-sec').style.display=m==='view'?'':'none';
  renderAll();
}
function toggleNames(){G.showNames=!G.showNames;document.getElementById('btn-names').classList.toggle('active',G.showNames);autoSave();renderNodes();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHARACTER MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openCharModal(id){
  G.editCid=id||null;G.pImg=null;G.pFlags=[];G.pBorderColor='none';G.pBorderWidth=4;
  const c=id?G.chars.find(x=>x.id===id):null;
  document.getElementById('char-modal-title').textContent=c?'Edit Character':'New Character';
  document.getElementById('char-name-inp').value=c?c.name:'';
  const av=document.getElementById('av-preview'),ph=document.getElementById('av-ph');
  if(c?.img){av.src=c.img;av.style.display='block';ph.style.display='none';}else{av.style.display='none';ph.style.display='flex';}
  G.pFlags=c?.flags?[...c.flags]:[];
  G.pBorderColor=c?.borderColor||'none';
  G.pBorderWidth=c?.borderWidth||4;
  buildFlagPicker();buildBorderPicker();
  // selection state is applied inside buildFlagPicker itself
  document.querySelectorAll('.border-swatch').forEach(s=>s.classList.toggle('on',s.dataset.bc===G.pBorderColor));
  if(G.pBorderColor!=='none')document.getElementById('border-color-inp').value=G.pBorderColor;
  document.getElementById('border-width-inp').value=G.pBorderWidth;
  updateFlagInfo();
  document.getElementById('char-modal').classList.add('on');
  setTimeout(()=>document.getElementById('char-name-inp').focus(),60);
}
function closeCharModal(){document.getElementById('char-modal').classList.remove('on');document.getElementById('av-inp').value='';}
function handleAvImg(inp){const f=inp.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{G.pImg=e.target.result;const av=document.getElementById('av-preview');av.src=e.target.result;av.style.display='block';document.getElementById('av-ph').style.display='none';};r.readAsDataURL(f);}
function saveChar(){
  const name=document.getElementById('char-name-inp').value.trim();if(!name){document.getElementById('char-name-inp').focus();return;}
  const borderColor=document.getElementById('border-color-inp').value;
  const finalBorderColor=G.pBorderColor==='none'?'none':(G.pBorderColor||borderColor);
  const borderWidth=parseInt(document.getElementById('border-width-inp').value)||4;
  if(G.editCid){
    const c=G.chars.find(x=>x.id===G.editCid);
    if(c){c.name=name;if(G.pImg)c.img=G.pImg;c.flags=[...G.pFlags];c.borderColor=finalBorderColor;c.borderWidth=borderWidth;}
  } else {
    const pos=newPos();G.chars.push({id:'c'+Date.now(),name,img:G.pImg||null,x:pos.x,y:pos.y,flags:[...G.pFlags],borderColor:finalBorderColor,borderWidth});
  }
  closeCharModal();autoSave();renderAll();
}
function newPos(){const n=G.chars.length;if(!n)return{x:400,y:300};const r=Math.min(800,600)*.33,a=(n/(n+1))*Math.PI*2-Math.PI/2;return{x:400+r*Math.cos(a),y:300+r*Math.sin(a)};}
function deleteChar(id){G.chars=G.chars.filter(c=>c.id!==id);G.links=G.links.filter(l=>l.fromId!==id&&l.toId!==id);if(G.selChar===id)G.selChar=null;autoSave();renderAll();}
function autoLayout(){const n=G.chars.length;if(!n)return;const cx=400,cy=300;
  // Scale radius so nodes never overlap: min gap of 20px between node edges
  const minR=Math.max(200,Math.min(700,500)*.36);
  const circumference=n*(NR*2+30);const rFromCircumference=circumference/(2*Math.PI);
  const r=Math.max(minR,rFromCircumference);
  G.chars.forEach((c,i)=>{const a=(i/n)*Math.PI*2-Math.PI/2;c.x=cx+r*Math.cos(a);c.y=cy+r*Math.sin(a);});autoSave();fitView();renderAll();}
function clearAll(){if(!confirm('Clear all characters and connections?'))return;G.chars=[];G.links=[];G.selChar=null;G.selLink=null;autoSave();renderAll();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REL TYPES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addRelType(){const name=document.getElementById('new-rt-name').value.trim();if(!name)return;const color=document.getElementById('new-rt-color').value;G.relTypes.push({id:'rt'+Date.now(),name,color});document.getElementById('new-rt-name').value='';autoSave();renderAll();}
function deleteRelType(id){G.relTypes=G.relTypes.filter(r=>r.id!==id);G.links.forEach(l=>{l.types=l.types.filter(t=>t.rtId!==id);});G.links=G.links.filter(l=>l.types.length>0);autoSave();renderAll();}
function renderRTList(){const list=document.getElementById('rt-list');list.innerHTML='';G.relTypes.forEach(rt=>{const d=document.createElement('div');d.className='rt-row';d.innerHTML=`<span class="rt-dot" style="background:${rt.color}"></span><span class="rt-name">${esc(rt.name)}</span>${G.mode==='edit'?`<span class="rt-acts"><button onclick="deleteRelType('${rt.id}')">‚úï</button></span>`:''}`;list.appendChild(d);});}
function ensureFilters(){G.relTypes.forEach(rt=>{if(G.filters[rt.id]===undefined)G.filters[rt.id]=true;});}
function renderFilterList(){ensureFilters();const list=document.getElementById('filter-list');list.innerHTML='';G.relTypes.forEach(rt=>{const on=G.filters[rt.id];const d=document.createElement('div');d.className='filter-row';d.innerHTML=`<span class="rt-dot" style="background:${rt.color};opacity:${on?1:.3}"></span><span style="flex:1;font-size:12px;opacity:${on?1:.5}">${esc(rt.name)}</span><span style="color:${on?rt.color:'var(--ink3)'};font-size:14px">${on?'‚óè':'‚óã'}</span>`;d.onclick=()=>{G.filters[rt.id]=!G.filters[rt.id];renderFilterList();renderLinks();};list.appendChild(d);});}
function filterAll(v){G.relTypes.forEach(rt=>G.filters[rt.id]=v);renderFilterList();renderLinks();}
function renderCharList(){
  const list=document.getElementById('char-list');list.innerHTML='';
  G.chars.forEach((c,i)=>{
    const d=document.createElement('div');d.className='char-row'+(G.selChar===c.id?' active':'');d.draggable=true;
    const th=c.img?`<img src="${c.img}" style="width:26px;height:26px;border-radius:50%;object-fit:cover;">`:`<span>‚óé</span>`;
    d.innerHTML=`<div class="char-thumb">${th}</div><span class="char-row-name">${esc(c.name)}</span>
    ${G.mode==='edit'?`<span class="char-row-acts"><button onclick="event.stopPropagation();openCharModal('${c.id}')">‚úé</button><button onclick="event.stopPropagation();deleteChar('${c.id}')">‚úï</button></span>`:''}`;
    d.addEventListener('click',()=>{if(G.mode==='view')selectCharView(c.id);});
    // drag to reorder
    d.addEventListener('dragstart',e=>e.dataTransfer.setData('charIdx',i));
    d.addEventListener('dragover',e=>{e.preventDefault();d.style.background='var(--violet-light)';});
    d.addEventListener('dragleave',()=>d.style.background='');
    d.addEventListener('drop',e=>{e.preventDefault();d.style.background='';const fromIdx=parseInt(e.dataTransfer.getData('charIdx'));if(isNaN(fromIdx)||fromIdx===i)return;const [item]=G.chars.splice(fromIdx,1);G.chars.splice(i,0,item);autoSave();renderCharList();});
    list.appendChild(d);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LINK MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openLinkModal(lid){
  editLinkId=lid;const link=G.links.find(l=>l.id===lid);if(!link)return;
  const list=document.getElementById('lt-list');list.innerHTML='';
  G.relTypes.forEach(rt=>{
    const t=link.types.find(t=>t.rtId===rt.id);
    const row=document.createElement('div');row.className='lt-row'+(t?' on':'');row.dataset.rtId=rt.id;
    row.innerHTML=`<span class="lt-swatch" style="background:${rt.color}"></span><span class="lt-label">${esc(rt.name)}</span>
    <div class="arr-btns">
      <button class="ab ${!t||t.arrow==='none'?' on':''}" data-dir="none">‚Äî</button>
      <button class="ab ${t?.arrow==='fwd'?' on':''}" data-dir="fwd">‚Üí</button>
      <button class="ab ${t?.arrow==='bwd'?' on':''}" data-dir="bwd">‚Üê</button>
    </div>`;
    row.querySelector('.lt-label').addEventListener('click',()=>row.classList.toggle('on'));
    row.querySelector('.lt-swatch').addEventListener('click',()=>row.classList.toggle('on'));
    row.querySelectorAll('.ab').forEach(btn=>btn.addEventListener('click',e=>{e.stopPropagation();row.querySelectorAll('.ab').forEach(b=>b.classList.remove('on'));btn.classList.add('on');if(!row.classList.contains('on'))row.classList.add('on');}));
    list.appendChild(row);
  });
  document.getElementById('link-modal').classList.add('on');
}
function closeLinkModal(){document.getElementById('link-modal').classList.remove('on');editLinkId=null;G.selLink=null;renderLinks();}
function saveLinkModal(){const link=G.links.find(l=>l.id===editLinkId);if(!link){closeLinkModal();return;}link.types=[];document.querySelectorAll('#lt-list .lt-row').forEach(row=>{if(row.classList.contains('on')){const rtId=row.dataset.rtId;const ab=row.querySelector('.ab.on');link.types.push({rtId,arrow:ab?ab.dataset.dir:'none'});}});if(link.types.length===0)G.links=G.links.filter(l=>l.id!==editLinkId);autoSave();closeLinkModal();}
function deleteLinkModal(){G.links=G.links.filter(l=>l.id!==editLinkId);autoSave();closeLinkModal();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEWPORT / ZOOM / PAN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyVP(){document.getElementById('canvas-transform').setAttribute('transform',`translate(${vp.x},${vp.y}) scale(${vp.scale})`);}
function adjustZoom(delta){const cx=CB().w/2,cy=CB().h/2;const factor=delta>0?1+delta:1/(1-delta);const nz=Math.max(0.15,Math.min(3,vp.scale*factor));const ratio=nz/vp.scale;vp.x=cx-(cx-vp.x)*ratio;vp.y=cy-(cy-vp.y)*ratio;vp.scale=nz;applyVP();}
function fitView(){if(!G.chars.length){vp={x:0,y:0,scale:1};applyVP();return;}const xs=G.chars.map(c=>c.x),ys=G.chars.map(c=>c.y);const minX=Math.min(...xs)-NR-40,maxX=Math.max(...xs)+NR+40,minY=Math.min(...ys)-NR-40,maxY=Math.max(...ys)+NR+40;const {w,h}=CB();const scaleX=w/(maxX-minX),scaleY=h/(maxY-minY),sc=Math.min(scaleX,scaleY,.98);vp.scale=sc;vp.x=(w-(maxX+minX)*sc)/2;vp.y=(h-(maxY+minY)*sc)/2;applyVP();}
function CB(){const el=document.getElementById('canvas-wrap');return{w:el.clientWidth,h:el.clientHeight};}

// canvas pan & zoom
const cvs=()=>document.getElementById('canvas');
function svgPt(clientX,clientY){const {w,h}=CB();const rect=cvs().getBoundingClientRect();const cx=clientX-rect.left,cy=clientY-rect.top;return{x:(cx-vp.x)/vp.scale,y:(cy-vp.y)/vp.scale};}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ALL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){renderRTList();renderFilterList();renderCharList();buildMarkers();renderLinks();renderNodes();document.getElementById('empty-state').style.display=G.chars.length===0?'flex':'none';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MARKERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildMarkers(){
  const defs=document.querySelector('#canvas defs');if(!defs)return;defs.querySelectorAll('marker').forEach(m=>m.remove());
  const ns='http://www.w3.org/2000/svg';
  G.relTypes.forEach(rt=>{
    ['end','start'].forEach(w=>{
      const m=document.createElementNS(ns,'marker');m.setAttribute('id',`ar_${w}_${rt.id}`);m.setAttribute('markerWidth','6');m.setAttribute('markerHeight','6');m.setAttribute('refX',w==='end'?'5':'1');m.setAttribute('refY','3');m.setAttribute('orient',w==='end'?'auto':'auto-start-reverse');
      const p=document.createElementNS(ns,'path');p.setAttribute('d','M0.5,0.5 L0.5,5.5 L5.5,3 z');p.setAttribute('fill',rt.color);m.appendChild(p);defs.appendChild(m);
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LINKS ‚Äî multi-type = one line that cycles colors in segments
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLinks(){
  const layer=document.getElementById('links-layer');layer.innerHTML='';ensureFilters();const ns='http://www.w3.org/2000/svg';
  G.links.forEach(link=>{
    const from=G.chars.find(c=>c.id===link.fromId),to=G.chars.find(c=>c.id===link.toId);if(!from||!to)return;
    // anchor points with gap
    const p1={x:from.x+(NR+LINK_GAP)*Math.cos(link.fromAngle),y:from.y+(NR+LINK_GAP)*Math.sin(link.fromAngle)};
    const p2={x:to.x+(NR+LINK_GAP)*Math.cos(link.toAngle),  y:to.y+(NR+LINK_GAP)*Math.sin(link.toAngle)};
    const mid={x:(p1.x+p2.x)/2,y:(p1.y+p2.y)/2};
    const cp={x:mid.x+(link.cpOffX||0),y:mid.y+(link.cpOffY||0)};
    const isSelected=G.selLink===link.id;
    const g=document.createElementNS(ns,'g');g.setAttribute('data-lid',link.id);

    const visTypes=link.types.filter(t=>{
      const fOk=G.mode==='edit'||G.filters[t.rtId]!==false;
      const cOk=G.mode==='edit'||G.selChar===null||link.fromId===G.selChar||link.toId===G.selChar;
      return fOk&&cOk;
    });
    const overallVis=visTypes.length>0;
    const nTypes=link.types.length;

    // In view mode with filters, check if we should show only filtered types' colors
    const activeFilterCount=G.mode==='view'?Object.values(G.filters).filter(v=>v).length:null;
    const totalTypes=G.relTypes.length;
    const filterActive=G.mode==='view'&&activeFilterCount!==null&&activeFilterCount<totalTypes;

    if(nTypes===0){} // nothing
    else if(nTypes===1){
      // Single type ‚Äî solid line
      const t=link.types[0];const rt=G.relTypes.find(r=>r.id===t.rtId);if(rt){
        const path=document.createElementNS(ns,'path');path.setAttribute('d',`M${p1.x},${p1.y} Q${cp.x},${cp.y} ${p2.x},${p2.y}`);path.setAttribute('stroke',rt.color);path.setAttribute('stroke-width','2.5');path.setAttribute('fill','none');path.setAttribute('stroke-linecap','round');path.setAttribute('opacity',overallVis?(isSelected?'1':'0.82'):'0.05');
        if(t.arrow==='fwd'||t.arrow==='both')path.setAttribute('marker-end',`url(#ar_end_${rt.id})`);
        if(t.arrow==='bwd'||t.arrow==='both')path.setAttribute('marker-start',`url(#ar_start_${rt.id})`);
        g.appendChild(path);
      }
    } else {
      // Multi-type ‚Äî in view mode with filter active, show only visible types with dotted pattern on same line
      // In edit mode or no filter, use half-and-half segments; for one-way use half segments
      const renderTypes = (filterActive&&visTypes.length>0) ? visTypes : link.types;
      const segPerType=12, totalSegs=renderTypes.length*segPerType;
      const pts=[];for(let i=0;i<=totalSegs;i++){const t=i/totalSegs;pts.push(bezierPt(p1,cp,p2,t));}

      // Approximate bezier arc length for dash sizing
      const approxLen=(()=>{let l=0,prev=p1;for(let i=1;i<=20;i++){const t=i/20;const pt=bezierPt(p1,cp,p2,t);l+=Math.sqrt((pt.x-prev.x)**2+(pt.y-prev.y)**2);prev=pt;}return l;})();
      // Target ~10 full color-cycles visible; clamp dash between 20 and 80px so always legible
      const calcDashUnit=(nTypes)=>Math.min(80,Math.max(20,approxLen/(10*nTypes)));

      if(filterActive&&visTypes.length>0){
        // In view mode with type filter: draw overlapping dotted lines on same bezier path
        const nTV=visTypes.length;const dashUnitV=calcDashUnit(nTV);
        visTypes.forEach((ltype,ti)=>{
          const rt=G.relTypes.find(r=>r.id===ltype.rtId);if(!rt)return;
          const path=document.createElementNS(ns,'path');path.setAttribute('d',`M${p1.x},${p1.y} Q${cp.x},${cp.y} ${p2.x},${p2.y}`);
          path.setAttribute('stroke',rt.color);path.setAttribute('stroke-width','3');path.setAttribute('fill','none');path.setAttribute('stroke-linecap','butt');
          path.setAttribute('stroke-dasharray',`${dashUnitV} ${(nTV-1)*dashUnitV}`);
          path.setAttribute('stroke-dashoffset',`${-(ti*dashUnitV)}`);
          path.setAttribute('opacity',isSelected?'1':'0.82');
          if(ltype.arrow==='fwd')path.setAttribute('marker-end',`url(#ar_end_${rt.id})`);
          if(ltype.arrow==='bwd')path.setAttribute('marker-start',`url(#ar_start_${rt.id})`);
          g.appendChild(path);
        });
      } else {
        // Multi-type ‚Äî segments: check if any have one-way arrows (use half for those), else use dots
        const hasOneWay=link.types.some(t=>t.arrow==='fwd'||t.arrow==='bwd');
        if(!hasOneWay){
          // All bidirectional or none ‚Äî dotted pattern, length-aware dash sizing
          const nT=link.types.length;const dashUnit=calcDashUnit(nT);
          link.types.forEach((ltype,ti)=>{
            const rt=G.relTypes.find(r=>r.id===ltype.rtId);if(!rt)return;
            const path=document.createElementNS(ns,'path');path.setAttribute('d',`M${p1.x},${p1.y} Q${cp.x},${cp.y} ${p2.x},${p2.y}`);
            path.setAttribute('stroke',rt.color);path.setAttribute('stroke-width','3');path.setAttribute('fill','none');path.setAttribute('stroke-linecap','butt');
            path.setAttribute('stroke-dasharray',`${dashUnit} ${(nT-1)*dashUnit}`);
            path.setAttribute('stroke-dashoffset',`${-(ti*dashUnit)}`);
            path.setAttribute('opacity',overallVis?(isSelected?'1':'0.82'):'0.05');
            if(ltype.arrow==='fwd')path.setAttribute('marker-end',`url(#ar_end_${rt.id})`);
            if(ltype.arrow==='bwd')path.setAttribute('marker-start',`url(#ar_start_${rt.id})`);
            g.appendChild(path);
          });
        } else {
          // Has one-way ‚Äî sort so bwd types are first (segment starts at p1) and fwd types last (segment ends at p2)
          // This ensures arrows always land at the real endpoints of the full line
          const sorted=[...link.types].sort((a,b)=>{
            const score=t=>t.arrow==='bwd'?0:t.arrow==='none'||!t.arrow?1:t.arrow==='both'?1:t.arrow==='fwd'?2:1;
            return score(a)-score(b);
          });
          const nSorted=sorted.length;
          const totalSegsSorted=nSorted*segPerType;
          const ptsSorted=[];for(let i=0;i<=totalSegsSorted;i++){const tt=i/totalSegsSorted;ptsSorted.push(bezierPt(p1,cp,p2,tt));}
          sorted.forEach((ltype,ti)=>{
            const rt=G.relTypes.find(r=>r.id===ltype.rtId);if(!rt)return;
            const start=ti*segPerType,end=(ti+1)*segPerType;
            const segPts=ptsSorted.slice(start,end+1);
            const d='M'+segPts.map(p=>`${p.x},${p.y}`).join(' L');
            const path=document.createElementNS(ns,'path');path.setAttribute('d',d);path.setAttribute('stroke',rt.color);path.setAttribute('stroke-width','2.5');path.setAttribute('fill','none');path.setAttribute('stroke-linecap','round');path.setAttribute('stroke-linejoin','round');
            path.setAttribute('opacity',overallVis?(isSelected?'1':'0.82'):'0.05');
            if(ltype.arrow==='fwd'||ltype.arrow==='both')path.setAttribute('marker-end',`url(#ar_end_${rt.id})`);
            if(ltype.arrow==='bwd'||ltype.arrow==='both')path.setAttribute('marker-start',`url(#ar_start_${rt.id})`);
            g.appendChild(path);
          });
        }
      }
    }

    // hit zone
    const hit=document.createElementNS(ns,'path');hit.setAttribute('d',`M${p1.x},${p1.y} Q${cp.x},${cp.y} ${p2.x},${p2.y}`);hit.setAttribute('stroke','transparent');hit.setAttribute('stroke-width','24');hit.setAttribute('fill','none');hit.setAttribute('class','link-hit');
    const fn=from.name,tn=to.name,tipTxt=link.types.map(t=>G.relTypes.find(r=>r.id===t.rtId)?.name||'').join(', ');
    hit.addEventListener('mouseenter',e=>showTip(e,`${fn} & ${tn}${tipTxt?' ‚Äî '+tipTxt:''}`));hit.addEventListener('mousemove',moveTip);hit.addEventListener('mouseleave',hideTip);
    hit.addEventListener('click',e=>{e.stopPropagation();G.selLink=G.selLink===link.id?null:link.id;renderLinks();});
    hit.addEventListener('dblclick',e=>{e.stopPropagation();openLinkModal(link.id);});
    g.appendChild(hit);

    // control point & anchor handles when selected
    if(isSelected&&G.mode==='edit'){
      // guide lines
      [[p1,cp],[p2,cp]].forEach(([pa,pb])=>{const l=document.createElementNS(ns,'line');l.setAttribute('x1',pa.x);l.setAttribute('y1',pa.y);l.setAttribute('x2',pb.x);l.setAttribute('y2',pb.y);l.setAttribute('class','ctrl-guide');g.appendChild(l);});
      // CP handle
      const ch=document.createElementNS(ns,'circle');ch.setAttribute('cx',cp.x);ch.setAttribute('cy',cp.y);ch.setAttribute('r','7');ch.setAttribute('class','ctrl-handle');
      ch.addEventListener('mousedown',e=>{e.stopPropagation();dragCP={linkId:link.id,sx:e.clientX,sy:e.clientY,ox:link.cpOffX||0,oy:link.cpOffY||0};hasDragged=false;e.preventDefault();});
      ch.addEventListener('touchstart',e=>{e.stopPropagation();const t=e.touches[0];dragCP={linkId:link.id,sx:t.clientX,sy:t.clientY,ox:link.cpOffX||0,oy:link.cpOffY||0};hasDragged=false;e.preventDefault();},{passive:false});
      g.appendChild(ch);
      // anchor handles on nodes
      [{c:from,angle:link.fromAngle,w:'from'},{c:to,angle:link.toAngle,w:'to'}].forEach(({c,angle,w})=>{
        const ax=c.x+(NR+LINK_GAP)*Math.cos(angle),ay=c.y+(NR+LINK_GAP)*Math.sin(angle);
        const ah=document.createElementNS(ns,'circle');ah.setAttribute('cx',ax);ah.setAttribute('cy',ay);ah.setAttribute('r','6');ah.setAttribute('class','ctrl-handle');ah.style.cursor='crosshair';
        const onMove=ev=>{const sp=svgPt(ev.clientX,ev.clientY);const na=Math.atan2(sp.y-c.y,sp.x-c.x);if(w==='from')link.fromAngle=na;else link.toAngle=na;renderLinks();};
        const onUp=()=>{autoSave();document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onUp);};
        ah.addEventListener('mousedown',e=>{e.stopPropagation();document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onUp);e.preventDefault();});
        g.appendChild(ah);
      });
    }
    layer.appendChild(g);
  });

  // drag preview line
  if(dragAnchor&&dragAnchor.px!==undefined){const ch=G.chars.find(c=>c.id===dragAnchor.cid);if(ch){const ax=ch.x+(NR+LINK_GAP)*Math.cos(dragAnchor.angle),ay=ch.y+(NR+LINK_GAP)*Math.sin(dragAnchor.angle);const ns='http://www.w3.org/2000/svg';const l=document.createElementNS(ns,'line');l.setAttribute('x1',ax);l.setAttribute('y1',ay);l.setAttribute('x2',dragAnchor.px);l.setAttribute('y2',dragAnchor.py);l.setAttribute('stroke','var(--violet)');l.setAttribute('stroke-width','2');l.setAttribute('stroke-dasharray','5 3');l.setAttribute('opacity','.7');l.setAttribute('pointer-events','none');layer.appendChild(l);}}
}

function bezierPt(p1,cp,p2,t){const mt=1-t;return{x:mt*mt*p1.x+2*mt*t*cp.x+t*t*p2.x,y:mt*mt*p1.y+2*mt*t*cp.y+t*t*p2.y};}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NODES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderNodes(){
  const layer=document.getElementById('nodes-layer');layer.innerHTML='';
  const defs=document.querySelector('#canvas defs');
  const ns='http://www.w3.org/2000/svg';
  const allFlags=LIB.customFlags;

  G.chars.forEach(c=>{
    const isLinkedToSel=G.selChar!==null&&G.links.some(l=>(l.fromId===G.selChar&&l.toId===c.id)||(l.toId===G.selChar&&l.fromId===c.id));
    const dimmed=G.mode==='view'&&G.selChar!==null&&G.selChar!==c.id&&!isLinkedToSel;
    const hl=G.mode==='view'&&G.selChar===c.id;
    const g=document.createElementNS(ns,'g');g.setAttribute('class','node-g'+(dimmed?' node-dim':'')+(hl?' node-hl':''));g.setAttribute('transform',`translate(${c.x},${c.y})`);g.setAttribute('data-id',c.id);

    // shadow ‚Äî only when border is set
    if(c.borderColor&&c.borderColor!=='none'){const sh=document.createElementNS(ns,'circle');sh.setAttribute('r',NR+2);sh.setAttribute('fill','rgba(0,0,0,.07)');sh.setAttribute('transform','translate(0,3)');g.appendChild(sh);}
    // white fill
    const bg=document.createElementNS(ns,'circle');bg.setAttribute('r',NR);bg.setAttribute('fill','#fff');g.appendChild(bg);

    // image
    if(c.img){
      const clipId='clip_'+c.id;
      if(!document.getElementById(clipId)){const cp=document.createElementNS(ns,'clipPath');cp.setAttribute('id',clipId);const cc=document.createElementNS(ns,'circle');cc.setAttribute('r',NR-(c.borderColor&&c.borderColor!=='none'?c.borderWidth||4:0));cp.appendChild(cc);defs.appendChild(cp);}
      const img=document.createElementNS(ns,'image');img.setAttribute('href',c.img);img.setAttribute('x',-NR);img.setAttribute('y',-NR);img.setAttribute('width',NR*2);img.setAttribute('height',NR*2);img.setAttribute('clip-path',`url(#clip_${c.id})`);img.setAttribute('preserveAspectRatio','xMidYMid slice');g.appendChild(img);
    } else {
      const t=document.createElementNS(ns,'text');t.setAttribute('text-anchor','middle');t.setAttribute('dominant-baseline','middle');t.setAttribute('font-family','DM Serif Display, serif');t.setAttribute('font-size','18');t.setAttribute('fill','var(--violet)');t.setAttribute('pointer-events','none');t.textContent=c.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();g.appendChild(t);
    }

    // border
    if(c.borderColor&&c.borderColor!=='none'){const border=document.createElementNS(ns,'circle');border.setAttribute('r',NR);border.setAttribute('fill','none');border.setAttribute('stroke',c.borderColor);border.setAttribute('stroke-width',c.borderWidth||4);g.appendChild(border);}
    else{const border=document.createElementNS(ns,'circle');border.setAttribute('r',NR);border.setAttribute('fill','none');border.setAttribute('stroke','var(--line)');border.setAttribute('stroke-width','1.5');g.appendChild(border);}

    // pride flags top-left ‚Äî as actual images, bigger
    if(c.flags?.length){
      c.flags.forEach((fid,fi)=>{
        const fd=allFlags.find(f=>f.id===fid);if(!fd)return;
        const fw=26,fh=16;const fx=-NR-2;const fy=-NR+fi*(fh+3);
        const clipId=`fclip_${c.id}_${fi}`;
        if(!document.getElementById(clipId)){const fcp=document.createElementNS(ns,'clipPath');fcp.setAttribute('id',clipId);const fr=document.createElementNS(ns,'rect');fr.setAttribute('width',fw);fr.setAttribute('height',fh);fr.setAttribute('rx','3');fcp.appendChild(fr);defs.appendChild(fcp);}
        const fg=document.createElementNS(ns,'g');fg.setAttribute('transform',`translate(${fx},${fy})`);
        const fi2=document.createElementNS(ns,'image');fi2.setAttribute('href',fd.img);fi2.setAttribute('x','0');fi2.setAttribute('y','0');fi2.setAttribute('width',fw);fi2.setAttribute('height',fh);fi2.setAttribute('clip-path',`url(#${clipId})`);fi2.setAttribute('preserveAspectRatio','xMidYMid slice');
        const bdr=document.createElementNS(ns,'rect');bdr.setAttribute('width',fw);bdr.setAttribute('height',fh);bdr.setAttribute('rx','3');bdr.setAttribute('fill','none');bdr.setAttribute('stroke','rgba(0,0,0,.2)');bdr.setAttribute('stroke-width','0.8');
        fg.appendChild(fi2);fg.appendChild(bdr);g.appendChild(fg);
      });
    }

    // name
    if(G.showNames){const nt=document.createElementNS(ns,'text');nt.setAttribute('y',NR+17);nt.setAttribute('class','node-name-text');nt.textContent=trunc(c.name,18);g.appendChild(nt);}

    // 16 anchor dots in edit mode
    if(G.mode==='edit'){
      for(let i=0;i<16;i++){
        const angle=(i/16)*Math.PI*2;const ax=NR*Math.cos(angle),ay=NR*Math.sin(angle);
        const dot=document.createElementNS(ns,'circle');dot.setAttribute('cx',ax);dot.setAttribute('cy',ay);dot.setAttribute('r','4');dot.setAttribute('class','anchor-dot');
        dot.addEventListener('mousedown',e=>{e.stopPropagation();dragAnchor={cid:c.id,angle,px:undefined,py:undefined};hasDragged=false;e.preventDefault();});
        dot.addEventListener('touchstart',e=>{e.stopPropagation();const t=e.touches[0];dragAnchor={cid:c.id,angle,px:undefined,py:undefined};hasDragged=false;e.preventDefault();},{passive:false});
        g.appendChild(dot);
      }
      // edit/delete btns
      [['‚úé',-(NR-3),-(NR-3),'var(--violet)',()=>openCharModal(c.id)],['‚úï',NR-3,-(NR-3),'var(--red)',()=>deleteChar(c.id)]].forEach(([sym,bx,by,col,fn])=>{
        const bg2=document.createElement('g'); // use SVG g
        const bg2s=document.createElementNS(ns,'g');bg2s.setAttribute('class','act-btn');
        const ci=document.createElementNS(ns,'circle');ci.setAttribute('cx',bx);ci.setAttribute('cy',by);ci.setAttribute('r','9');ci.setAttribute('fill','white');ci.setAttribute('stroke',col);ci.setAttribute('stroke-width','1.5');
        const tx=document.createElementNS(ns,'text');tx.setAttribute('x',bx);tx.setAttribute('y',by);tx.setAttribute('text-anchor','middle');tx.setAttribute('dominant-baseline','middle');tx.setAttribute('font-size','10');tx.setAttribute('fill',col);tx.setAttribute('pointer-events','none');tx.textContent=sym;
        bg2s.appendChild(ci);bg2s.appendChild(tx);bg2s.addEventListener('click',e=>{e.stopPropagation();fn();});g.appendChild(bg2s);
      });
    }

    setupNodeEvents(g,c);
    layer.appendChild(g);
  });
}

function setupNodeEvents(g,c){
  let sx,sy,ox,oy;
  g.addEventListener('mousedown',e=>{if(e.button!==0)return;const sp=svgPt(e.clientX,e.clientY);sx=e.clientX;sy=e.clientY;ox=c.x;oy=c.y;hasDragged=false;if(G.mode==='edit'&&!dragAnchor)dragNode={c,g,sx,sy,ox,oy};e.preventDefault();});
  g.addEventListener('click',e=>{e.stopPropagation();if(hasDragged)return;if(G.mode==='view')selectCharView(c.id);else{G.selLink=null;renderLinks();}});
  g.addEventListener('dblclick',e=>{e.stopPropagation();if(G.mode==='edit')openCharModal(c.id);});
  g.addEventListener('mouseenter',e=>showTip(e,c.name));g.addEventListener('mousemove',moveTip);g.addEventListener('mouseleave',hideTip);
  // touch
  g.addEventListener('touchstart',e=>{const t=e.touches[0];sx=t.clientX;sy=t.clientY;ox=c.x;oy=c.y;hasDragged=false;if(G.mode==='edit')dragNode={c,g,sx,sy,ox,oy};},{passive:true});
}

function selectCharView(id){G.selChar=G.selChar===id?null:id;renderLinks();renderNodes();renderCharList();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBAL MOUSE / TOUCH EVENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const cvsel=()=>document.getElementById('canvas');

cvsel().addEventListener('mousedown',e=>{
  if(e.button===1||(e.button===0&&!dragNode&&!dragAnchor&&!dragCP)){
    if(e.target===cvsel()||e.target.id==='canvas-transform'||e.target.id==='links-layer'||e.target.id==='nodes-layer'){
      panState={sx:e.clientX,sy:e.clientY,ox:vp.x,oy:vp.y};e.preventDefault();
    }
  }
});

cvsel().addEventListener('wheel',e=>{
  e.preventDefault();const factor=e.deltaY<0?1.1:0.9;const sp=svgPt(e.clientX,e.clientY);const nz=Math.max(0.15,Math.min(3,vp.scale*factor));const d=nz/vp.scale;
  vp.x=e.clientX-(e.clientX-vp.x)*d; // this needs proper approach
  // proper zoom toward cursor
  const rect=cvsel().getBoundingClientRect();const cx=e.clientX-rect.left,cy=e.clientY-rect.top;
  vp.x=cx-(cx-vp.x)*(nz/vp.scale);vp.y=cy-(cy-vp.y)*(nz/vp.scale);vp.scale=nz;applyVP();
},{passive:false});

// touch pinch & pan
cvsel().addEventListener('touchstart',e=>{
  if(e.touches.length===2){pinchState={d:pinchDist(e),sx:vp.x,sy:vp.y,sc:vp.scale,mx:(e.touches[0].clientX+e.touches[1].clientX)/2,my:(e.touches[0].clientY+e.touches[1].clientY)/2};dragNode=null;dragAnchor=null;}
  else if(e.touches.length===1&&!dragNode&&!dragAnchor){const t=e.touches[0];panState={sx:t.clientX,sy:t.clientY,ox:vp.x,oy:vp.y};}
},{passive:true});

cvsel().addEventListener('touchmove',e=>{
  if(pinchState&&e.touches.length===2){
    const d=pinchDist(e);const ratio=d/pinchState.d;const nz=Math.max(.15,Math.min(3,pinchState.sc*ratio));
    const mx=(e.touches[0].clientX+e.touches[1].clientX)/2,my=(e.touches[0].clientY+e.touches[1].clientY)/2;
    const rect=cvsel().getBoundingClientRect();const cx=mx-rect.left,cy=my-rect.top;
    vp.x=cx-(cx-pinchState.sx)*(nz/pinchState.sc);vp.y=cy-(cy-pinchState.sy)*(nz/pinchState.sc);vp.scale=nz;applyVP();e.preventDefault();return;
  }
  if(e.touches.length===1){
    const t=e.touches[0];
    if(dragNode){const dx=(t.clientX-dragNode.sx)/vp.scale,dy=(t.clientY-dragNode.sy)/vp.scale;if(Math.abs(dx)>2||Math.abs(dy)>2){hasDragged=true;dragNode.c.x=dragNode.ox+dx;dragNode.c.y=dragNode.oy+dy;dragNode.g.setAttribute('transform',`translate(${dragNode.c.x},${dragNode.c.y})`);renderLinks();} return;}
    if(dragAnchor){const sp=svgPt(t.clientX,t.clientY);dragAnchor.px=sp.x;dragAnchor.py=sp.y;hasDragged=true;renderLinks();return;}
    if(dragCP){const dx=(t.clientX-dragCP.sx)/vp.scale,dy=(t.clientY-dragCP.sy)/vp.scale;if(Math.abs(dx)>2||Math.abs(dy)>2){hasDragged=true;const link=G.links.find(l=>l.id===dragCP.linkId);if(link){link.cpOffX=dragCP.ox+dx;link.cpOffY=dragCP.oy+dy;renderLinks();}} return;}
    if(panState){vp.x=panState.ox+(t.clientX-panState.sx);vp.y=panState.oy+(t.clientY-panState.sy);applyVP();}
  }
},{passive:false});

cvsel().addEventListener('touchend',e=>{
  if(e.touches.length<2)pinchState=null;
  handleDragEnd(e.changedTouches[0].clientX,e.changedTouches[0].clientY);
  panState=null;
});

function pinchDist(e){const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;return Math.sqrt(dx*dx+dy*dy);}

document.addEventListener('mousemove',e=>{
  if(dragNode){const dx=(e.clientX-dragNode.sx)/vp.scale,dy=(e.clientY-dragNode.sy)/vp.scale;if(Math.abs(dx)>2||Math.abs(dy)>2){hasDragged=true;dragNode.c.x=dragNode.ox+dx;dragNode.c.y=dragNode.oy+dy;dragNode.g.setAttribute('transform',`translate(${dragNode.c.x},${dragNode.c.y})`);renderLinks();}return;}
  if(dragCP){const dx=(e.clientX-dragCP.sx)/vp.scale,dy=(e.clientY-dragCP.sy)/vp.scale;if(Math.abs(dx)>2||Math.abs(dy)>2){hasDragged=true;const link=G.links.find(l=>l.id===dragCP.linkId);if(link){link.cpOffX=dragCP.ox+dx;link.cpOffY=dragCP.oy+dy;renderLinks();}}return;}
  if(dragAnchor){const sp=svgPt(e.clientX,e.clientY);dragAnchor.px=sp.x;dragAnchor.py=sp.y;hasDragged=true;renderLinks();return;}
  if(panState){vp.x=panState.ox+(e.clientX-panState.sx);vp.y=panState.oy+(e.clientY-panState.sy);applyVP();}
});

document.addEventListener('mouseup',e=>{
  panState=null;
  handleDragEnd(e.clientX,e.clientY);
});

function handleDragEnd(clientX,clientY){
  if(dragAnchor&&hasDragged){
    const sp=svgPt(clientX,clientY);let bestCid=null,bestAngle=null,bestDist=Infinity;
    G.chars.forEach(c=>{if(c.id===dragAnchor.cid)return;for(let i=0;i<16;i++){const a=(i/16)*Math.PI*2;const ax=c.x+(NR+LINK_GAP)*Math.cos(a),ay=c.y+(NR+LINK_GAP)*Math.sin(a);const d=Math.sqrt((sp.x-ax)**2+(sp.y-ay)**2);if(d<25&&d<bestDist){bestDist=d;bestCid=c.id;bestAngle=a;}}const d2=Math.sqrt((sp.x-c.x)**2+(sp.y-c.y)**2);if(d2<=NR+LINK_GAP+15&&d2<bestDist){bestDist=d2;bestCid=c.id;bestAngle=Math.atan2(sp.y-c.y,sp.x-c.x);}});
    if(bestCid){const existing=G.links.find(l=>(l.fromId===dragAnchor.cid&&l.toId===bestCid)||(l.fromId===bestCid&&l.toId===dragAnchor.cid));if(existing){G.selLink=existing.id;openLinkModal(existing.id);}else{const nl={id:'l'+Date.now(),fromId:dragAnchor.cid,toId:bestCid,fromAngle:dragAnchor.angle,toAngle:bestAngle,cpOffX:0,cpOffY:0,types:[]};G.links.push(nl);G.selLink=nl.id;openLinkModal(nl.id);}}
  }
  if(dragCP&&hasDragged)autoSave();
  if(dragNode&&hasDragged)autoSave();
  dragNode=null;dragCP=null;dragAnchor=null;
}

cvsel().addEventListener('click',e=>{
  if(e.target===cvsel()||e.target.id==='canvas-transform'||e.target.id==='links-layer'||e.target.id==='nodes-layer'){G.selLink=null;G.selChar=null;renderLinks();renderCharList();}
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOOLTIP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTip(e,txt){const t=document.getElementById('tip');t.textContent=txt;t.classList.add('on');moveTip(e);}
function moveTip(e){const t=document.getElementById('tip');t.style.left=(e.clientX+13)+'px';t.style.top=(e.clientY-28)+'px';}
function hideTip(){document.getElementById('tip').classList.remove('on');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastT=null;
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('on');clearTimeout(toastT);toastT=setTimeout(()=>t.classList.remove('on'),2600);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function trunc(s,n){return s.length>n?s.slice(0,n-1)+'‚Ä¶':s;}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function closeModal(id){
  const el=document.getElementById(id);if(!el)return;
  el.classList.remove('on');
  // reset callbacks
  if(id==='name-modal')_nameModalCb=null;
  if(id==='char-modal'){document.getElementById('av-inp').value='';}
  if(id==='link-modal'){editLinkId=null;G.selLink=null;renderLinks();}
}

let _confirmModalCb=null;
function openConfirm(title,msg,onConfirm,okLabel='Delete'){
  document.getElementById('confirm-modal-title').textContent=title;
  document.getElementById('confirm-modal-msg').textContent=msg;
  document.getElementById('confirm-modal-ok').textContent=okLabel;
  _confirmModalCb=onConfirm;
  document.getElementById('confirm-modal').classList.add('on');
}
function resolveConfirm(yes){
  document.getElementById('confirm-modal').classList.remove('on');
  if(yes&&_confirmModalCb)_confirmModalCb();
  _confirmModalCb=null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('load',()=>{
  loadLib();
  renderLib();
  renderAll();
  updateChartLabel();
  document.getElementById('btn-names').classList.toggle('active',G.showNames);
  document.getElementById('char-name-inp').addEventListener('keydown',e=>{if(e.key==='Enter')saveChar();});
  document.getElementById('new-rt-name').addEventListener('keydown',e=>{if(e.key==='Enter')addRelType();});
  document.getElementById('folder-name-inp').addEventListener('keydown',e=>{if(e.key==='Enter')confirmFolder();});
  setInterval(autoSave,30000);
  // init vp centered
  vp={x:0,y:0,scale:1};applyVP();
  setTimeout(fitView,100);
});
</script>
</body>
</html>